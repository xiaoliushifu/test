<?php
$d=array(
	array("a",-20319),		//数字从小到大的排序       -20319最小
	array("ai",-20317),
	array("an",-20304),
	array("ang",-20295),
	array("ao",-20292),
	array("ba",-20283),
	array("bai",-20265),
	array("ban",-20257),
	array("bang",-20242),
	array("bao",-20230),
	array("bei",-20051),
	array("ben",-20036),
	array("beng",-20032),
	array("bi",-20026),
	array("bian",-20002),
	array("biao",-19990),
	array("bie",-19986),
	array("bin",-19982),
	array("bing",-19976),
	array("bo",-19805),
	array("bu",-19784),
	array("ca",-19775),
	array("cai",-19774),
	array("can",-19763),
	array("cang",-19756),
	array("cao",-19751),
	array("ce",-19746),
	array("ceng",-19741),
	array("cha",-19739),
	array("chai",-19728),
	array("chan",-19725),
	array("chang",-19715),
	array("chao",-19540),
	array("che",-19531),
	array("chen",-19525),
	array("cheng",-19515),
	array("chi",-19500),
	array("chong",-19484),
	array("chou",-19479),
	array("chu",-19467),
	array("chuai",-19289),
	array("chuan",-19288),
	array("chuang",-19281),
	array("chui",-19275),
	array("chun",-19270),
	array("chuo",-19263),
	array("ci",-19261),
	array("cong",-19249),
	array("cou",-19243),
	array("cu",-19242),
	array("cuan",-19238),
	array("cui",-19235),
	array("cun",-19227),
	array("cuo",-19224),
	array("da",-19218),
	array("dai",-19212),
	array("dan",-19038),
	array("dang",-19023),
	array("dao",-19018),
	array("de",-19006),
	array("deng",-19003),
	array("di",-18996),
	array("dian",-18977),
	array("diao",-18961),
	array("die",-18952),
	array("ding",-18783),
	array("diu",-18774),
	array("dong",-18773),
	array("dou",-18763),
	array("du",-18756),
	array("duan",-18741),
	array("dui",-18735),
	array("dun",-18731),
	array("duo",-18722),
	array("e",-18710),
	array("en",-18697),
	array("er",-18696),
	array("fa",-18526),
	array("fan",-18518),
	array("fang",-18501),
	array("fei",-18490),
	array("fen",-18478),
	array("feng",-18463),
	array("fo",-18448),
	array("fou",-18447),
	array("fu",-18446),
	array("ga",-18239),
	array("gai",-18237),
	array("gan",-18231),
	array("gang",-18220),
	array("gao",-18211),
	array("ge",-18201),
	array("gei",-18184),
	array("gen",-18183),
	array("geng",-18181),
	array("gong",-18012),
	array("gou",-17997),
	array("gu",-17988),
	array("gua",-17970),
	array("guai",-17964),
	array("guan",-17961),
	array("guang",-17950),
	array("gui",-17947),
	array("gun",-17931),
	array("guo",-17928),
	array("ha",-17922),
	array("hai",-17759),
	array("han",-17752),
	array("hang",-17733),
	array("hao",-17730),
	array("he",-17721),
	array("hei",-17703),
	array("hen",-17701),
	array("heng",-17697),
	array("hong",-17692),
	array("hou",-17683),
	array("hu",-17676),
	array("hua",-17496),
	array("huai",-17487),
	array("huan",-17482),
	array("huang",-17468),
	array("hui",-17454),
	array("hun",-17433),
	array("huo",-17427),
	array("ji",-17417),
	array("jia",-17202),
	array("jian",-17185),
	array("jiang",-16983),
	array("jiao",-16970),
	array("jie",-16942),
	array("jin",-16915),
	array("jing",-16733),
	array("jiong",-16708),
	array("jiu",-16706),
	array("ju",-16689),
	array("juan",-16664),
	array("jue",-16657),
	array("jun",-16647),
	array("ka",-16474),
	array("kai",-16470),
	array("kan",-16465),
	array("kang",-16459),
	array("kao",-16452),
	array("ke",-16448),
	array("ken",-16433),
	array("keng",-16429),
	array("kong",-16427),
	array("kou",-16423),
	array("ku",-16419),
	array("kua",-16412),
	array("kuai",-16407),
	array("kuan",-16403),
	array("kuang",-16401),
	array("kui",-16393),
	array("kun",-16220),
	array("kuo",-16216),
	array("la",-16212),
	array("lai",-16205),
	array("lan",-16202),
	array("lang",-16187),
	array("lao",-16180),
	array("le",-16171),
	array("lei",-16169),
	array("leng",-16158),
	array("li",-16155),
	array("lia",-15959),
	array("lian",-15958),
	array("liang",-15944),
	array("liao",-15933),
	array("lie",-15920),
	array("lin",-15915),
	array("ling",-15903),
	array("liu",-15889),
	array("long",-15878),
	array("lou",-15707),
	array("lu",-15701),
	array("lv",-15681),
	array("luan",-15667),
	array("lue",-15661),
	array("lun",-15659),
	array("luo",-15652),
	array("ma",-15640),
	array("mai",-15631),
	array("man",-15625),
	array("mang",-15454),
	array("mao",-15448),
	array("me",-15436),
	array("mei",-15435),
	array("men",-15419),
	array("meng",-15416),
	array("mi",-15408),
	array("mian",-15394),
	array("miao",-15385),
	array("mie",-15377),
	array("min",-15375),
	array("ming",-15369),
	array("miu",-15363),
	array("mo",-15362),
	array("mou",-15183),
	array("mu",-15180),
	array("na",-15165),
	array("nai",-15158),
	array("nan",-15153),
	array("nang",-15150),
	array("nao",-15149),
	array("ne",-15144),
	array("nei",-15143),
	array("nen",-15141),
	array("neng",-15140),
	array("ni",-15139),
	array("nian",-15128),
	array("niang",-15121),
	array("niao",-15119),
	array("nie",-15117),
	array("nin",-15110),
	array("ning",-15109),
	array("niu",-14941),
	array("nong",-14937),
	array("nu",-14933),
	array("nv",-14930),
	array("nuan",-14929),
	array("nue",-14928),
	array("nuo",-14926),
	array("o",-14922),
	array("ou",-14921),
	array("pa",-14914),
	array("pai",-14908),
	array("pan",-14902),
	array("pang",-14894),
	array("pao",-14889),
	array("pei",-14882),
	array("pen",-14873),
	array("peng",-14871),
	array("pi",-14857),
	array("pian",-14678),
	array("piao",-14674),
	array("pie",-14670),
	array("pin",-14668),
	array("ping",-14663),
	array("po",-14654),
	array("pu",-14645),
	array("qi",-14630),
	array("qia",-14594),
	array("qian",-14429),
	array("qiang",-14407),
	array("qiao",-14399),
	array("qie",-14384),
	array("qin",-14379),
	array("qing",-14368),
	array("qiong",-14355),
	array("qiu",-14353),
	array("qu",-14345),
	array("quan",-14170),
	array("que",-14159),
	array("qun",-14151),
	array("ran",-14149),
	array("rang",-14145),
	array("rao",-14140),
	array("re",-14137),
	array("ren",-14135),
	array("reng",-14125),
	array("ri",-14123),
	array("rong",-14122),
	array("rou",-14112),
	array("ru",-14109),
	array("ruan",-14099),
	array("rui",-14097),
	array("run",-14094),
	array("ruo",-14092),
	array("sa",-14090),
	array("sai",-14087),
	array("san",-14083),
	array("sang",-13917),
	array("sao",-13914),
	array("se",-13910),
	array("sen",-13907),
	array("seng",-13906),
	array("sha",-13905),
	array("shai",-13896),
	array("shan",-13894),
	array("shang",-13878),
	array("shao",-13870),
	array("she",-13859),
	array("shen",-13847),
	array("sheng",-13831),
	array("shi",-13658),
	array("shou",-13611),
	array("shu",-13601),
	array("shua",-13406),
	array("shuai",-13404),
	array("shuan",-13400),
	array("shuang",-13398),
	array("shui",-13395),
	array("shun",-13391),
	array("shuo",-13387),
	array("si",-13383),
	array("song",-13367),
	array("sou",-13359),
	array("su",-13356),
	array("suan",-13343),
	array("sui",-13340),
	array("sun",-13329),
	array("suo",-13326),
	array("ta",-13318),
	array("tai",-13147),
	array("tan",-13138),
	array("tang",-13120),
	array("tao",-13107),
	array("te",-13096),
	array("teng",-13095),
	array("ti",-13091),
	array("tian",-13076),
	array("tiao",-13068),
	array("tie",-13063),
	array("ting",-13060),
	array("tong",-12888),
	array("tou",-12875),
	array("tu",-12871),
	array("tuan",-12860),
	array("tui",-12858),
	array("tun",-12852),
	array("tuo",-12849),
	array("wa",-12838),
	array("wai",-12831),
	array("wan",-12829),
	array("wang",-12812),
	array("wei",-12802),
	array("wen",-12607),
	array("weng",-12597),
	array("wo",-12594),
	array("wu",-12585),
	array("xi",-12556),
	array("xia",-12359),
	array("xian",-12346),
	array("xiang",-12320),
	array("xiao",-12300),
	array("xie",-12120),
	array("xin",-12099),
	array("xing",-12089),
	array("xiong",-12074),
	array("xiu",-12067),
	array("xu",-12058),
	array("xuan",-12039),
	array("xue",-11867),
	array("xun",-11861),
	array("ya",-11847),
	array("yan",-11831),
	array("yang",-11798),
	array("yao",-11781),
	array("ye",-11604),
	array("yi",-11589),
	array("yin",-11536),
	array("ying",-11358),
	array("yo",-11340),
	array("yong",-11339),
	array("you",-11324),
	array("yu",-11303),
	array("yuan",-11097),
	array("yue",-11077),
	array("yun",-11067),
	array("za",-11055),
	array("zai",-11052),
	array("zan",-11045),
	array("zang",-11041),
	array("zao",-11038),
	array("ze",-11024),
	array("zei",-11020),
	array("zen",-11019),
	array("zeng",-11018),
	array("zha",-11014),
	array("zhai",-10838),
	array("zhan",-10832),
	array("zhang",-10815),
	array("zhao",-10800),
	array("zhe",-10790),
	array("zhen",-10780),
	array("zheng",-10764),
	array("zhi",-10587),
	array("zhong",-10544),
	array("zhou",-10533),
	array("zhu",-10519),
	array("zhua",-10331),
	array("zhuai",-10329),
	array("zhuan",-10328),
	array("zhuang",-10322),
	array("zhui",-10315),
	array("zhun",-10309),
	array("zhuo",-10307),
	array("zi",-10296),
	array("zong",-10281),
	array("zou",-10274),
	array("zu",-10270),
	array("zuan",-10262),
	array("zui",-10260),
	array("zun",-10256),
	array("zuo",-10254)             //-10254最大
);
function g($num){				//由对应数字，获得$d数组里的信息，如zuo,zuan等
	global $d;
	if($num>0&&$num<160){
	   return chr($num);	//返回对应ASCII字符
	}
	elseif($num<-20319||$num>-10247){
	   return "";
	}else{
	   for($i=count($d)-1;$i>=0;$i--)
	    {if($d[$i][1]<=$num)break;}			//这个和405行的代码，还是有点区别的
	   return $d[$i][0];
	}
}

function c($str){
	$str=mb_convert_encoding($str ,'GB2312',"UTF-8");	
	$ret="";
	for($i=0;$i<strlen($str);$i++)
	{
	   $p=ord(substr($str,$i,1));			//由响应的字符，返回对应的ASCII码值（数字）
	   if($p>160)
	   {							//如果ASCII码值大于160，就再获取下一个字节
	    $q=ord(substr($str,++$i,1));
	    $p=$p*256+$q-65536;					//这个表达式是要计算什么？  需要对字符集有个了解吧？
	   }
	   $ret.=g($p);
	}
	$ret=mb_convert_encoding($ret ,"UTF-8",'GB2312');//返回一些字符
	return $ret;
}




	/**
	* getPhone
	*
	* 这个内部函数用于在固定电话和手机中优先输出一个。
	*
	* @since v0.1
	*
	* @example $result= getPhone($input,$select)；
	*
	* @todo 
	* 
	* @param $input，一个放了2个string的数组，[0]是固定电话号码，[1]是手机号码。
	* @param string $select, 返回值选择开关 1=手机优先,2=固定电话优先
	*
	* @return string 电话号码/FALSE
	*/
function getPhone($input,$select){ //select
	if ($select=='1'){
		if($input[1]!='')
			return $input[1];
		else if ($input[0]!='')
			return $input[0];
		else 
			return FALSE;		
	}
	else if ($select=='2'){
		if($input[0]!='')
			return $input[0];
		else if ($input[1]!='')
			return $input[1];
		else 
			return FALSE;		
	}
	else { //输入参数不对
		return FALSE;
	}
}


	/**
	* getFloor
	*
	* 这个内部函数用于将数字类型的楼层信息还原和分离，并返回文本形式的层数。
	*
	* @since v0.1
	*
	* @example $result= $getFloor($input,$select)；
	*
	* @todo 
	* 
	* @param $input，从数据库中获得的楼层信息整数。
	* @param string $select, 返回值选择开关total=总层数,floor=当前层
	*
	* @return string 楼层数字/FALSE
	*/
function getFloor($input,$select){ //select total=总层数,floor=当前层
	$output=(int)$input;

	if ($select=='floor')
	{
		$tmp = abs($output) ;
		$output = $tmp - intval($tmp/100)*100;
		if($input < 0 )//地下室
		{
			$output = $output*(-1);
		}
	}

	else if ($select=='total'){
		$output=abs(intval($output/100));
	}
	else { //输入参数不对
		return FALSE;
	}
	return (string)$output;		
}
	/**
	* getRoom
	*
	* 这个内部函数用于将数字类型的户型信息还原和分离，并返回文本形式的室厅厨卫生阳的数目。
	*
	* @since v0.1
	*
	* @example $result= getRoom($input,$select)；
	*
	* @todo 
	* 
	* @param $input，从数据库中获得的房屋信息整数。
	* @param string $select, shi=室，ting厅，chu厨，wei卫，yang阳台
	*
	* @return string 房间数量/FALSE
	*/
function getRoom($input,$select){ //select 
	$input=(string)$input;//转成字符串，因为传进来的参数可能是整型的
	if ($select=='shi')
		$output= substr($input,0,1);
	else if ($select=='ting')
		$output= substr($input,1,1);
	else if ($select=='chu')
		$output= substr($input,2,1);
	else if ($select=='wei')
		$output= substr($input,3,1);
	else if ($select=='yang')
		$output= substr($input,4,1);
	else { //输入参数不对
		return FALSE;
	}
	return (string)$output;		
}

/*FunName:		getDBArray
 * 该函数返回连接数据库的信息
 * @Param       无
 * Return Type:				 Array
 * @Return ：             host 数据库所在的服务器IP地址
 * @Return ：             port 服务器工作的端口号
 * @Return ：             user 用户名
 * @Return ：             password 密码
 * @Return ：             dbname 哪个数据库
 * 
 * */
function getDBArray()
{
	return array(
					'host'=>'192.168.0.160',
					'port'=>3306,
					'user'=>'sycxuser',
					'password'=>'tuitui99_2009abc',
					'dbname'=>'test'
				);
}
/*FunName:		getPayment
 * 该函数返回连接数据库的信息
 * @Param       $input     0-9   
 * @Param       $select   mortgage=押,pay=付
 * @Return    	$output   返回对应的数字，押的多少，  或者付的多少
 * 
 * 
 * */

function getPayment($input,$select){ //select mortgage=押,pay=付
		$output=(int)$input;
		if($output == 1)
		{
			$mortgage = 1;
			$pay = 3;
		}elseif($output == 2)
		{
			$mortgage = 1;
			$pay = 1;
		}
		elseif($output == 3)
		{
			$mortgage = 1;
			$pay = 6;
		}
		elseif($output == 4)
		{
			$mortgage = 2;
			$pay = 3;
		}
		elseif($output == 5)
		{
			$mortgage = 2;
			$pay = 2;
		}
		elseif($output == 6)
		{
			$mortgage = 2;
			$pay = 1;
		}
		elseif($output == 7)
		{
			$mortgage = 1;
			$pay = 12;
		}
		elseif($output == 8)
		{
			$mortgage = 0;
			$pay = 6;
		}
		elseif($output == 9)
		{
			$mortgage = 0;
			$pay = 12;
		}
		else
		{
			if($select=='mortgage')
			{
				$output = $output-intval($output/10)*10;//获取多位数的个位数字，如123，将获得3；但intval好像不保险。
			}
			else if($select=='pay')
			{
				$output=abs(intval($output/100));//获取多位数的百位至以上的数字，如1234，将获得12.
			}
			else { //输入参数不对
				return FALSE;
			}
		}
		if($input <=9)
		{
			if($select=='mortgage')
				$output = $mortgage;
			else
				$output = $pay;
		}
		return (string)$output;		
	}
/*FunName:		getPayment
 * 返回数据库的链接资源 conn
 * @Param       $city     城市的代号 10，代表杭州   
 * @Param       $company  
 * @Param    	$addr   默认为1 ；数据库服务器地址代号 
 * 
 * 
 * */
function ConDBRe($city , $company , $addr = 1)	//连接刷新数据库（喜刷刷和一键刷新）
{
		switch($city)
		{
			case 1:
				$dbname = 'test' ;
				break ;
			case 2:
				if($company == 'yfdc')
				{
					$dbname = 'yufeng_db' ;
				}
				else
				{
					$dbname = 'test_guangzhou' ;
				}
				break ;
			case 3:
				$dbname = 'test_shenzhen' ;
				break ;
			case 4:
				$dbname = 'test_chengdu' ;
				break ;
			case 5:
				$dbname = 'test_shanghai' ;
				break ;
			case 6:
				$dbname = 'test_tianjin' ;
				break ;
			case 7:
				$dbname = 'test_chongqing' ;
				break ;
			case 8:
				$dbname = 'test_changchun' ;
				break ;
			case 9:
				$dbname = 'test_suzhou' ;
				break ;
			case 10:
				$dbname = 'test_hangzhou' ;
				break ;
			case 11:
				$dbname = 'test_dalian' ;
				break ;
			case 12:
				$dbname = 'test_zhengzhou' ;
				break ;
			case 13:
				$dbname = 'test_wuhan' ;
				break ;
			case 14:
				$dbname = 'test_dongguan' ;
				break ;
			case 15:
				$dbname = 'test_zhuhai' ;
				break ;
			case 16:
				$dbname = 'test_shenyang' ;
				break ;
			case 17:
				$dbname = 'test_shijiazhuang' ;
				break ;
			case 18:
				$dbname = 'test_xian' ;
				break ;
			case 19:
				$dbname = 'test_jinan' ;
				break ;
			case 20:
				$dbname = 'test_kunming' ;
				break ;
			case 21:
				$dbname = 'test_fuzhou' ;
				break ;
			case 22:
				$dbname = 'test_nanjing' ;
				break ;
			case 23:
				$dbname = 'test_changsha' ;
				break ;
			case 24:
				$dbname = 'test_huizhou' ;
				break ;
			case 25:
				$dbname = 'test_hainan' ;
				break ;
			case 26:
				$dbname = 'test_foshan' ;
				break ;
			case 27:
				$dbname = 'test_wuxi' ;
				break ;
			case 28:
				$dbname = 'test_guiyang' ;
				break ;
			case 29:
				$dbname = 'test_xiamen' ;
				break ;
			case 30:
				$dbname = 'test_zhongshan' ;
				break ;		
			case 31:
				$dbname = 'test_yulin' ;
				break ;													
			default:
				$dbname = 'test' ;
				break ;
		}	
	if($addr  == 1) //对应主数据库
	{
		$host = '192.168.0.160' ;
		$user = 'sycxuser' ;
		$password = 'tuitui99_2009abc' ;
	}
	else//对应本地数据库
	{
		$host = 'localhost' ;
		$user = 'root' ;
		$password = 'sycx_2009abc' ;
	}
	$conn=mysql_connect($host ,$user, $password);
	if($conn == FALSE) return FALSE ;
	if(!mysql_select_db($dbname,$conn))
	{
		mysql_close($conn) ;
		return FALSE ;
	}
	return $conn ;
}
/*FunName:		getDbInfo
 * 返回数据库的信息           数组形式   数组包含四个元素 ，每个元素都是一个特定数据库的用户名密码等信息的子数组
 * @Param       $city     城市的代号 10，代表杭州   
 * @Param       $company  
 * 
 * */
	function getDbInfo($city , $company)
	{
		$dbInfo = array();
		
		$host1 = 'localhost';
		$user1 = 'root';
		$password1 = 'sycx_2009abc';
		$dbname1 = 'test';
		
		$host2 = '192.168.0.160';
		$user2 = 'sycxuser';
		$password2 = 'tuitui99_2009abc';		
		$dbname2 = 'test';
		
		$host3 = '192.168.0.105';
		$user3 = 'sycxuser';
		$password3 = 'tuitui99_2009abc';		
		$dbname3 = 'test';
		
		$host4 = '192.168.0.161';
		$user4 = 'sycxuser';
		$password4 = 'tuitui99_2009abc';		
		$dbname4 = 'test';
		switch($city)
		{
			case 1:
				$dbname = 'test' ;
				break ;
			case 2:
				if($company == 'yfdc')
				{
					$dbname = 'yufeng_db' ;
				}
				else
				{
					$dbname = 'test_guangzhou' ;
				}
				break ;
			case 3:
				$dbname = 'test_shenzhen' ;
				break ;
			case 4:
				$dbname = 'test_chengdu' ;
				break ;
			case 5:
				$dbname = 'test_shanghai' ;
				break ;
			case 6:
				$dbname = 'test_tianjin' ;
				break ;
			case 7:
				$dbname = 'test_chongqing' ;
				break ;
			case 8:
				$dbname = 'test_changchun' ;
				break ;
			case 9:
				$dbname = 'test_suzhou' ;
				break ;
			case 10:
				$dbname = 'test_hangzhou' ;
				break ;
			case 11:
				$dbname = 'test_dalian' ;
				break ;
			case 12:
				$dbname = 'test_zhengzhou' ;
				break ;
			case 13:
				$dbname = 'test_wuhan' ;
				break ;
			case 14:
				$dbname = 'test_dongguan' ;
				break ;
			case 15:
				$dbname = 'test_zhuhai' ;
				break ;
			case 16:
				$dbname = 'test_shenyang' ;
				break ;
			case 17:
				$dbname = 'test_shijiazhuang' ;
				break ;
			case 18:
				$dbname = 'test_xian' ;
				break ;
			case 19:
				$dbname = 'test_jinan' ;
				break ;
			case 20:
				$dbname = 'test_kunming' ;
				break ;
			case 21:
				$dbname = 'test_fuzhou' ;
				break ;
			case 22:
				$dbname = 'test_nanjing' ;
				break ;
			case 23:
				$dbname = 'test_changsha' ;
				break ;
			case 24:
				$dbname = 'test_huizhou' ;
				break ;
			case 25:
				$dbname = 'test_hainan' ;
				break ;
			case 26:
				$dbname = 'test_foshan' ;
				break ;
			case 27:
				$dbname = 'test_wuxi' ;
				break ;
			case 28:
				$dbname = 'test_guiyang' ;
				break ;
			case 29:
				$dbname = 'test_xiamen' ;
				break ;
			case 30:
				$dbname = 'test_zhongshan' ;
				break ;			
			case 31:
				$dbname = 'test_yulin' ;
				break ;											
			default:
				$dbname = 'test' ;
				break ;
		}			
		$dbname1 = $dbname;
		$dbname2 = $dbname;
		$dbname4 = $dbname;
		$dbInfo['cookieDB'] = array(
			'host'=>$host1,
			'user'=>$user1,
			'password'=>$password1,
			'dbname'=>$dbname1,
			'charset'=>'',
		);
		$dbInfo['feedbackDB'] = array(
			'host'=>$host2,
			'user'=>$user2,
			'password'=>$password2,
			'dbname'=>$dbname2,
		'charset'=>'',
		);
		$dbInfo['remoteDB'] = array(
			'host'=>$host3,
			'user'=>$user3,
			'password'=>$password3,
			'dbname'=>$dbname3,		//这个dbname3是固定的test
		'charset'=>'',
		);
		$dbInfo['newfeedbackDB'] = array(
			'host'=>$host4,
			'user'=>$user4,
			'password'=>$password4,
			'dbname'=>$dbname4,
		'charset'=>'',
		);
		return $dbInfo;
	}


	/*
	 * 去指定的$url处获得页面数据，并存储于$path/basename.$suffix的文件中，返回路径和文件名。
	 * 
	 * $url   用来获取页面信息的url
	 * $path	保存页面信息的本地路径
	 * $suffix  保存页面信息的文件的后缀
	 * */
	function Download_Data($url , $refer , $path = '' , $suffix = '')
	{

	$content = '' ;
	if(empty($url))
		return $content ;
	if(!strstr($url , 'http'))		//没有http就选择本站localhost
		$url = 'http://127.0.0.1/'.$url ;
	if(!empty($path) && !is_dir($path))
		mkdir($path) ;//这个函数的使用
	if(is_array($url))  //多个文件需要下载
	{
		$mh = curl_multi_init();
		foreach ($url as $i => $tmp_url)
		{
			if(!empty($tmp_url) && strstr($tmp_url , '/'))
			{
				$conn[$i] = curl_init(); 
				curl_setopt($conn[$i] , CURLOPT_TIMEOUT, 30);
				curl_setopt($conn[$i] , CURLOPT_REFERER, $refer);
				curl_setopt($conn[$i] , CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; )'); 
				curl_setopt($conn[$i] , CURLOPT_URL, trim($tmp_url));             //设定目标URL
				curl_setopt($conn[$i] , CURLOPT_RETURNTRANSFER, 1);
				curl_setopt($conn[$i] , "Connection", "Keep-Alive");  
				if(!empty($path))          //如果有路径    
				{
					$filename = basename($tmp_url) ;
					if(strstr($filename , '='))
						$filename = rand(0,10000000) ;
					else
						$filename = rand(0,1000).$filename ;
					$content[$i] = $path.'/'.$filename.$suffix;
					$tmp_fp[$i]=fopen ($content[$i] , "wb");
//					$content[$i] = $domain.'/'.$content[$i] ;
					curl_setopt($conn[$i] , CURLOPT_FILE, $tmp_fp[$i]);
				}
				
				curl_multi_add_handle ($mh,$conn[$i]);
			}
		}
		$mrc = curl_multi_exec($mh,$active);
		do
		{
		 	$mrc = curl_multi_exec($mh,$active);
		 	
		}while ( $mrc == CURLM_CALL_MULTI_PERFORM );
		while ($active and $mrc == CURLM_OK)
		{
		 	if (curl_multi_select($mh) != -1)
		 	{
		 		do
		 		{
		 			$mrc = curl_multi_exec($mh, $active);
		 		}while ($mrc == CURLM_CALL_MULTI_PERFORM);
			 }
		}
		foreach ($url as $i => $tmp_url)
		{
			if(empty($tmp_url))
				$content[$i] = '' ;
			elseif(!strstr($tmp_url , '/'))
				$content[$i] = $tmp_url ;
			else
			{
				$err_code = curl_error($conn[$i]) ;
				if(!empty($err_code))
					$content[$i] = '' ;
				else
				{
					if(empty($path))
						$content[$i] = curl_multi_getcontent($conn[$i]);
					else
						fclose($tmp_fp[$i]) ;
				}
				curl_multi_remove_handle($mh,$conn[$i]) ;
				curl_close($conn[$i]);
			}
		}
		curl_multi_close($mh) ;
	}
	else
	{
		if(!strstr($url , '/'))
			return $url ;
		$ch = curl_init(); 
		curl_setopt($ch , CURLOPT_TIMEOUT, 30);
		curl_setopt($ch , CURLOPT_REFERER, $refer);
		curl_setopt($ch , CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; )'); 
		curl_setopt($ch , CURLOPT_URL, trim($url));             //设定目标URL
		curl_setopt($ch , CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($ch , "Connection", "Keep-Alive");//可以这样写吗
		if(!empty($path))          //如果有路径    
		{
			$filename = basename($url) ;
			if(strstr($filename , '='))//如果有Query,如xxxxxx.html?name=aa&age=23这样的情况
				$filename = mt_rand(0,1000000000) ;	
			else
				$filename = rand(0,1000).$filename ;
			$content = $path.'/'.$filename.$suffix ;
			$tmp_fp=fopen ($content , "wb");//w写入方式打开，内容截为0.无则创建；b则在写入时不转换某些特殊的字符，如换行符
//			$content[$i] = $domain.'/'.$content[$i] ;
			curl_setopt($ch , CURLOPT_FILE, $tmp_fp);//设定输出文件的位置，资源类型。以前我们可以用$content变量来接收，现在通过设置它可以放在文件里
			curl_exec( $ch );                                                                //发送请求 
			fclose($tmp_fp) ;
		}
		else
		{
			$content = curl_exec( $ch );
		}
		curl_close( $ch );                        //会话结束 ;
	}
	return $content ;
}
	

/*由UTF-8码，返回Unicode码，以%u6CB2的形式返回*/
function getUnicodeFromOneUTF8($word) //单汉字转U码
{   
  		//获取其字符的内部数组表示，所以本文件应用utf-8编码！   
  		if (is_array( $word))   
    		$arr = $word;   
  		else     
    		$arr = str_split($word);//字符串单个字符转成数组，第二个参数也可指定几个字符做为数组的一个元素返回    
  		$bin_str = '';      
  		foreach ($arr as $value)   
    		$bin_str .= decbin(ord($value)); //码值的十进制转二进制 
    		//1110xxxx 10xxxxxx 10xxxxxx   UTF-8编码下的汉字模板（三字节）
    		//    xxxx   xxxxxx   xxxxxx
  		$bin_str = preg_replace('/^.{4}(.{4}).{2}(.{6}).{2}(.{6})$/','$1$2$3', $bin_str);//用反向引用替换符合patten模式的字符，实则是整体替换    
  		return '%u'.dechex(bindec($bin_str)); //二进制转十进制，再转十六进制   
}
/*
 * 
 * 传人16进制Unicode码
 * */
function unicode_to_utf8( $unicode_hex ) //熟悉一下 unicode字符集和utf-8的编码方式
{

    $unicode = hexdec($unicode_hex);//16转10

    $utf8 = '';

    if ( $unicode < 128 ) {//一个字节
        $utf8 = chr( $unicode );//用ASCII字符集，返回码值对应的字符

    } elseif ( $unicode < 2048 ) {//1000 00000000（两个字节）110XXXXX 10XXXXXX
        $utf8 .= chr( 192 + ( ( $unicode - ( $unicode % 64 ) ) / 64 ) );
        $utf8 .= chr( 128 + ( $unicode % 64 ) );

    } else {//三个字节1110XXXX 10XXXXXX 10XXXXXX

        $utf8 .= chr( 224 + ( ( $unicode - ( $unicode % 4096 ) ) / 4096 ) );
        $utf8 .= chr( 128 + ( ( ( $unicode % 4096 ) - ( $unicode % 64 ) ) /
        64 ) );
        $utf8 .= chr( 128 + ( $unicode % 64 ) );

    } // if
    return $utf8;
}
/*
 * 
 * 传入单个字符
 * */
function getUTF8FromOneUnicode($str)    
{
    //判断长度
    if((strlen($str)%4) != 0 )//每个字符串的长度和编码有关吗？有关
        return FALSE;
    //计算byte[]的长度
    $len = strlen($str)/4;
    $str_result = '';
    //循环复制
    for($i=0;$i<$len;$i++){
        $str_unicode_hex = substr($str, $i*4, 4);
        $str_result .= unicode_to_utf8($str_unicode_hex);
    }
    return $str_result;
}
/*
 * 传入字符串
 * */
function getUTF8FromStringUnicode($str , $val)
{
	$len = strlen($val) ;//strlen的长度，确实返回的是字符数，但是跟编码有关，utf-8的汉字，它会测试三个字节为一个字符，GBK的话，它会测量两个字节为一个字符
	$string = '' ;
	do
	{
		$tmp = substr($str , 0 , $len) ;
		if(strcmp($tmp , $val) == 0)
		{
			$string .= getUTF8FromOneUnicode(substr($str , $len ,  4)) ;
			$str = substr($str , $len + 4) ;
		}		
		else
		{
			$string .= substr($str , 0 , 1) ;
			$str = substr($str , 1) ;
		}
	}while(!empty($str)) ;
	return $string ;
}

function getArray($string , $sort = '') //字符串转数组,UTF-8,如何把一个字符串按单个字符拆分成数组，而且，这个方法最重要的是
//考虑了字符串里含有中文的情况。
{
	$content=array() ;
	$len=strlen($string);   
  	for($i=0;$i<$len;$i++)
  	{   
  		if(ord(substr($string,$i,1))>0xa0)
  		{   

             switch($sort)
             {
             	case 'unicode':
             		$content[]=getUnicodeFromOneUTF8(substr($string,$i,3)) ; 
             		break ;
             	default :
             		$content[]= substr($string,$i,3) ;
             }
             $i+=2   ;   
  		}   
         else
        {   
        	$content[]=substr($string,$i,1);   
        }   
    
  	}   
  	return $content ;
}
//获得区属的名字，获得区属辖区下的街道名字
function getPosition($city ,$sort , $zid , $sid = '')
{
	$zid = intval($zid) ;
	$sid = intval($sid) ;
	include './webfiles/common/config.inc';
	switch($sort)
	{
		case 'zone':
			$name = $zone_name[$city][$zid]['name'] ;
			break ;
		case 'street':
			$name = $zone_name[$city][$zid][$sid] ;
			break ;
		default:
			return FALSE ;
	}
	if($name)
	{
		if($city == 1)//没有旁边
		{
			if(strstr($name ,','))
			{
				$name = current(explode(',',$name));
			}
		}
	}
	return $name;
}
//返回一个前缀固定的txt文件名称
function localfile($action,$sessionid,$siteid,$dataid,$userid){
		if ($action=='')
			$action='1';
		if ($sessionid=='')
			$sessionid='1';
		if ($siteid=='')
			$siteid='1';
		if ($dataid=='')
			$dataid='1';
		if ($userid=='')
			$userid='1';
		$name="/opt/lampp/htdocs/webpost/datafile/{$action}_{$sessionid}_{$siteid}_{$dataid}_{$userid}.txt";
		return ($name);	//加括号与不加括号的区别
}
	
	
function processClickRet($o ,$ret,$web)
{
	$hot = $ret['status'];
	if(is_array($ret))
	{
		$out=array(
			'dataType'=>'', //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'action' => 'click',//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=>'', //推送编号
			'userID'=>$ret['uid'],		//用户编号
			'userID2'=>$ret['uid2'],		//用户编号
			'siteID'=>$ret['sid'],		//目标网站编号
			'dataID'=>'' ,		//被推送数据编号
			'status'=>9,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'pic'=>'',    //验证码图片binary
			'remoteHref'=>'',	//成功推送的远程链接地址
			'remoteID'=>'',	//成功推送的远程编号				
			'error'=> array('level' => 10 , 'type' => '点击' , 'msg' => $web->errInfo , 'source' => $web->content) ,
			'hot' => $hot ,
			'excute' => '' ,
			'real' => '' ,
			'ret'=>$ret,
			);
		$o->exe($out);
		return 1;	
	}
	else
	{
		return 0;
	}
}
function processLoginRet($o ,$ret,$web , $status = 'login')
{
	if($status == 'login')
	{
		$excute = 'login' ;
	}
	else
	{
		$excute = 'loginTest' ;//好像是刚刚添加的账号，执行验证的时候走的分支吧？
	}
	if(is_array($ret))				//是数组
	{
		$hot = $ret['status'] ;
	}
	elseif($ret == true)		//非空       和1220行的判断有什么逻辑关系吗？
	{
		$hot = 9 ;
	}
	else
	{
		$hot = 0 ;
	}
	//没有登录成功，去进行入库操作，但只对一些付费网站，且错误类型也有限制。符合的才可入库，表名ff_websites_account_stat
	if($hot != 9)
	{
		$web->nurse4sms($web->user['uid'],$web->site[$web->siteid]['wid'],$web->site[$web->siteid]['id'],$web->errInfo);
	}
	if(!is_array($ret) && (strlen($ret) > 10)) //需要验证码         							//为什么这种情况是验证码呢？
	{
		$out=array(
			'dataType'=>isset($web->data[$web->dataid]['dataType'])?$web->data[$web->dataid]['dataType']:'', //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'action' => 'login',//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=>$web->sessionid, //推送编号，$data[id]
			'userID'=>$web->user['uid'],		//用户编号，UID又是什么字段
			'siteID'=>$web->site[$web->siteid]['id'],		//当前网站的一个账号id,标识当前网站的一个账号
			'dataID'=>isset($web->data[$web->dataid]['ID'])?$web->data[$web->dataid]['ID']:'' ,		//被推送数据编号，标识一条房源
			'status'=>2,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'pic'=>$ret,    //验证码图片binary					//嗯？
			'remoteHref'=>'',	//成功推送的远程链接地址
			'remoteID'=>'',	//成功推送的远程编号				
			'error'=> array('level' => 10 , 'type' => '登陆' , 'msg' => $web->errInfo , 'source' => $web->content) ,
			'hot' => $hot ,
			'excute' => $excute ,
			'real' => empty($web->user['real'])?0:1 ,//real又是什么字段
			);
		$o->exe($out);
		$web->save();//序列化当前对象，并存储于特定文件中
		return 2;	
	}
	//是数组，但不是9的情况
	elseif(($ret==false) || (is_array($ret) && ($hot != 9)))//login失败
	{
		$out=array(
			
			'action' => 'login',//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=>$web->sessionid, //推送编号，代表某一次推送
			'userID'=>$web->user['uid'],		//用户编号
			'siteID'=>$web->site[$web->siteid]['id'],		//当前网站的一个账号id,标识当前网站的一个账号
			'dataID'=>isset($web->data[$web->dataid]['ID'])?$web->data[$web->dataid]['ID']:'' ,	//被推送数据编号，房源id
			'dataType'=>isset($web->data[$web->dataid]['dataType'])?$web->data[$web->dataid]['dataType']:'' , //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'status'=>0,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'error'=> array('level' => 1 , 'type' => '登陆' , 'msg' => $web->errInfo , 'source' => $web->content) ,//content也在啊
			'remoteHref'=>'',	//成功推送的远程链接地址
			'remoteID'=>'',	//成功推送的远程编号	
			'pic'=>'',    //验证码图片binary	
			'hot' => $hot ,
			'excute' => $excute ,
			'real' => empty($web->user['real'])?0:1 ,
		);
		$o->exe($out);
		$web->dele();//删除临时文件
		return 0;		
	}
	else //成功
	{
		$out=array(
			'action' => 'login' ,//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=>$web->sessionid, //推送编号，data['id']在setup中赋予sessionid
			'userID'=>$web->user['uid'],		//用户编号
			'siteID'=>$web->site[$web->siteid]['id'],		//当前网站的一个账号id,标识当前网站的一个账号
			'dataID'=>isset($web->data[$web->dataid]['ID'])?$web->data[$web->dataid]['ID']:'' ,//被推送数据编号，标识一条房源
			'dataType'=>isset($web->data[$web->dataid]['dataType'])?$web->data[$web->dataid]['dataType']:'' , //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'status'=>9,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'remoteHref'=>'',	//成功推送的远程链接地址
			'remoteID'=>'' ,	//成功推送的远程编号
			'pic'=>'',    //验证码图片binary		
			'error'=> array('level' => 10 , 'type' => '登陆' , 'msg' => '' , 'source' => '')  ,//与前两个不同
			'hot' => $hot ,
			'excute' => $excute ,
			'real' => empty($web->user['real'])?0:1 ,//真实房源套餐
		);
		$o->exe($out);//更新ff_push_tmps表PID为1，Type为9
		$web->dele();//删除临时文件，但登录成功时没有建立临时文件，
		return 1;
	}
	
		
}

	
function processRegisterRet($o , $ret,$web){
	if(empty($web->errInfo))
		$level = 10 ;
	else
		$level = 5 ;
	if ((!is_array($ret)) && ($ret != FALSE))//登陆需要验证码
	{
		$out=array(
			'dataType'=>isset($web->data[$web->dataid]['dataType'])?$web->data[$web->dataid]['dataType']:'', //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'action'=>'register',//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=>$web->sessionid, //推送编号
			'userID'=>$web->user['uid'],		//用户编号
			'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
			'dataID'=>isset($web->data[$web->dataid]['ID'])?$web->data[$web->dataid]['ID']:'',		//被推送数据编号
			'status'=>2,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'pic'=>$ret,    //验证码图片binary
			'remoteHref'=>'',	//成功推送的远程链接地址
			'remoteID'=>'' ,	//成功推送的远程编号		
		 	'error'=> array('level' => $level , 'type' => '注册' , 'msg' => $web->errInfo , 'source' => $web->content) ,
		);
		$o->exe($out);
		$web->save();
	}
	else if (is_array($ret))//成功
	{
		$out=array(
			'dataType'=>isset($web->data[$web->dataid]['dataType'])?$web->data[$web->dataid]['dataType']:'', //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'action'=>'register',//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=>$web->sessionid, //推送编号
			'userID'=>$web->user['uid'],		//用户编号
			'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
			'dataID'=>isset($web->data[$web->dataid]['ID'])?$web->data[$web->dataid]['ID']:'',		//被推送数据编号
			'status'=>9,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'pic'=>'',    //验证码图片binary
//			'remoteHref'=>'',	//成功推送的远程链接地址
//			'remoteID'=>''	//成功推送的远程编号	
			'registerPassword'=> $ret['key'] ,
			'registerUsername'=> $ret['username']  ,
			'error'=> array('level' => $level , 'type' => '注册' , 'msg' => $web->errInfo , 'source' => $web->content) ,
			'hot' => $ret['status'] ,
		);
		$o->exe($out);
 		$web->dele();
	}
	else //失败
	{
		$out=array(
			'dataType'=>isset($web->data[$web->dataid]['dataType'])?$web->data[$web->dataid]['dataType']:'', //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'action'=>'register',//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=>$web->sessionid, //推送编号
			'userID'=>$web->user['uid'],		//用户编号
			'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
			'dataID'=>isset($web->data[$web->dataid]['ID'])?$web->data[$web->dataid]['ID']:'',		//被推送数据编号
			'status'=>0,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'error'=>$web->content,
			'pic'=>'',    //验证码图片binary
			'remoteHref'=>'',	//成功推送的远程链接地址
			'remoteID'=>'',	//成功推送的远程编号	
			'error'=> array('level' => 1 , 'type' => '注册' , 'msg' => $web->errInfo , 'source' => $web->content) ,
		);
		$o->exe($out);
		$web->dele(); 		
	}
}


//处理推送结果
function processPostRet($o , $ret,$web)
{
	/*确定错误类型Start*/
    if(empty($web->errInfo))
			$level = 10 ;
		else
			$level = 5 ;
	/*确定错误类型End*/
	if (is_array($ret) )//是数组，就有可能推送成功
	{
		if ($ret['url']!='' && $ret['id']!='')//数组中含有url,id等信息,就真的推送成功了
		{
			$web->log .="记录发送成功！在{$ret['url']}\n";
			$output=array(
				'dataType'=>$web->data[$web->dataid]['dataType'], //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
				'action'=>'post_light',//(register,login,post_light,insert,update,upd,refresh,delete)
				'pushID'=>$web->sessionid, //推送编号，标识该条房源属于那一次推送
				'userID'=>$web->user['uid'],		//用户编号
				'siteID'=>$web->site[$web->siteid]['id'],		//当前网站的账号编号，标识当前网站的一个账号
				'dataID'=>$web->data[$web->dataid]['ID'],		//本次推送成功房源的编号，标识一条房源
				'status'=>9,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
				'pic'=>'',    //验证码图片binary
				'remoteHref'=>$ret['url'],	//成功推送后，该条房源在Internet上的url
				'remoteID'=>$ret['id']	,//成功推送的远程编号，用于后续对该房源的删除，刷新等操作	
				//error['source']里有$web->content	
				'error'=> array('level' => $level , 'type' => '推送' , 'msg' => $web->errInfo , 'source' => $web->content) ,
				'wid' => 	$web->site[$web->siteid]['wid'],//网站编号，标识一个网站，如114代表 赶集免费
				'real' => empty($web->user['real'])?0:1 ,//真实房源套餐???	
				);
			//调用feedback返回结果'action','pushID','userID','siteID','dataID','dataType','status','remoteHref','remoteID','pic','registerUsername','registerPassword'
			$o->exe($output);//这个方法很重要
			$web->dele();
			return 1;//next
		}else
		{ //未知异常情况
			$web->log.="数据返回结果异常！\n";
			$output=array(
				'dataType'=>$web->data[$web->dataid]['dataType'], //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
				'action'=>'post_light',//(register,login,post_light,insert,update,upd,refresh,delete)
				'pushID'=>$web->sessionid, //推送编号
				'userID'=>$web->user['uid'],		//用户编号
				'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
				'dataID'=>$web->data[$web->dataid]['ID'],		//被推送数据编号  标识一条房源
				'status'=>0,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
				'error'=> array('level' => $level , 'type' => '推送' , 'msg' => $web->errInfo , 'source' => $web->content) ,	
				'wid' => 	$web->site[$web->siteid]['wid'],
				'real' => empty($web->user['real'])?0:1 ,
				);
			$o->exe($output);	
			$web->dele();//删除特定文件名的文件
			return 1;//next 为异常时为啥还返回1呢？？？
		}
	}/*elseif($ret!=FALSE)//这是以前的代码，这种情况，现在已经没有了。验证的情况直接在网站文件中处理了，city58.php
	{
			$web->log.="本记录发送需要图片验证！\n";
			$output=array(
				'dataType'=>$web->data[$web->dataid]['dataType'], //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
				'action'=>'post_light',//(register,login,post_light,insert,update,upd,refresh,delete)
				'pushID'=>$web->sessionid, //推送编号
				'userID'=>$web->user['uid'],		//用户编号
				'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
				'dataID'=>$web->data[$web->dataid]['ID'],		//被推送数据编号
				'status'=>2,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
				'pic'=>$ret,    //验证码图片binary
				'error'=> array('level' => $level , 'type' => '推送' , 'msg' => $web->errInfo , 'source' => $web->content) ,
				'wid' => 	$web->site[$web->siteid]['wid'],
				'real' => empty($web->user['real'])?0:1 ,				
				);
			$web->save();
			//调用feedback返回结果
			$o->exe($output);				
			return 0;//pause
	}*/else //推送失败时的处理和 登录失败时的处理
	{
		/*这个nurse4sms只针对6个付费网站做处理。向ff_websites_account_stat中插入或者更新记录。是关于给客户发短信的处理Start*/
		$web->nurse4sms($web->user['uid'],$web->site[$web->siteid]['wid'],$web->site[$web->siteid]['id'],$web->errInfo);
		/*向ff_websites_account_stat中插入或者更新记录。是关于给客户发短信的处理End*/
		$web->log .='返回的数据不是array，发送失败!\n';
		if($web->errInfoStatus)//登录失败时为1,   这个errInfoStatus属性好像也是旧代码
		{
			$hot = 0;
		}else
		{
			$hot = 11;
		}
		if($web->falseStatus)//falseStatus属性，好像是旧的代码，有些网站文件中仍然出现这个属性
		{
			$hot = 7;
		}
		$output=array(
			'action'=>'post_light',//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=>$web->sessionid, //推送编号，标识该条房源属于哪一次推送
			'userID'=>$web->user['uid'],		//用户编号
			'siteID'=>$web->site[$web->siteid]['id'],		//目标网站的账号id，标识当前网站的一个账号
			'dataID'=>$web->data[$web->dataid]['ID'],		//被推送数据编号    标识一条房源
			'dataType'=>$web->data[$web->dataid]['dataType'], //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'status'=> $hot,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'error'=> array('level' => 1 , 'type' => '推送' , 'msg' => $web->errInfo , 'source' => $web->content) ,			
			'wid' => $web->site[$web->siteid]['wid'],//网站id，标识一个网站，如,58付费是218
			'real' => empty($web->user['real'])?0:1 ,//据说是真实房源的处理
			);
		if(strstr($web->errInfo , '数据推送失败，未知错误') && ($output['status'] == 0))
			$output['status'] = 5 ;
		$o->exe($output);//推送失败时，这是一个很重要的步骤
		$web->dele();//删除特定文件名的文件
		return 1;//next		
	}
}
function processUpdateRet($o , $ret,$web)
{
	    if(empty($web->errInfo))
				$level = 10 ;
			else
				$level = 5 ;
			if (is_array($ret))
			{ 
				$historyid = $web->getHistoryID() ;
			if ($ret['url']!='' && $ret['id']!='')
			{
				$web->log.="记录更新成功！在{$ret['url']}\n";
				$output=array(
					'dataType'=>$web->data[$web->dataid]['dataType'], //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
					'action'=>'update',//(register,login,post_light,insert,update,upd,refresh,delete)
					'pushID'=>$web->sessionid, //推送编号
					'userID'=>$web->user['uid'],		//用户编号
					'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
					'dataID'=>$web->data[$web->dataid]['ID'],		//被推送数据编号
					'status'=>9,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
					'pic'=>'',    //验证码图片binary
					'remoteHref'=>$ret['url'],	//成功推送的远程链接地址
					'remoteID'=>$ret['id'],	//成功推送的远程编号			
					'error'=> array('level' => $level , 'type' => '更新' , 'msg' => $web->errInfo , 'source' => $web->content) ,	
					'oldInfo' => $web->history[$historyid] ,	//原来的id和url
					'wid' => 	$web->site[$web->siteid]['wid'],
					'real' => empty($web->user['real'])?0:1 ,
					);
				//调用feedback返回结果'action','pushID','userID','siteID','dataID','dataType','status','remoteHref','remoteID','pic','registerUsername','registerPassword'
				$o->exe($output);
				$web->dele();
				return 1;
			}
			else 
			{
				$web->log.="更新数据返回结果异常！\n";
				$output=array(
					'dataType'=>$web->data[$web->dataid]['dataType'], //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
					'action'=>'update',//(register,login,post_light,insert,update,upd,refresh,delete)
					'pushID'=>$web->sessionid, //推送编号
					'userID'=>$web->user['uid'],		//用户编号
					'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
					'dataID'=>$web->data[$web->dataid]['ID'],		//被推送数据编号
					'status'=>0,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
					'oldInfo' => $web->history[$historyid] ,	//原来的id和url
					'error'=> array('level' => $level , 'type' => '更新' , 'msg' => $web->errInfo , 'source' => $web->content) ,
					'wid' => 	$web->site[$web->siteid]['wid'],	
					'real' => empty($web->user['real'])?0:1 ,		
					);
				$o->exe($output);	
				$web->dele();
				return 1;
			}
		}
		elseif($ret!=FALSE)
		{
				$historyid = $web->getHistoryID() ;
				$web->log.="本记录更新需要图片验证！\n";
				$output=array(
					'dataType'=>$web->data[$web->dataid]['dataType'], //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
					'action'=>'update',//(register,login,post_light,insert,update,upd,refresh,delete)
					'pushID'=>$web->sessionid, //推送编号
					'userID'=>$web->user['uid'],		//用户编号
					'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
					'dataID'=>$web->data[$web->dataid]['ID'],		//被推送数据编号
					'status'=>2,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
					'pic'=>$ret,    //验证码图片binary
					'oldInfo' => $web->history[$historyid] ,	//原来的id和url
					'error'=> array('level' => $level , 'type' => '更新' , 'msg' => $web->errInfo , 'source' => $web->content) ,
					'wid' => 	$web->site[$web->siteid]['wid'],		
					'real' => empty($web->user['real'])?0:1 ,			
					);
				$web->save();
				//调用feedback返回结果
				$o->exe($output);				
				return 0;//pause
		}
		else//ret 不是array说明发送失败
		{
			$historyid = $web->getHistoryID() ;
			$web->log.='更新返回的数据不是array，更新失败!\n';
			$output=array(
				'dataType'=>$web->data[$web->dataid]['dataType'], //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
				'action'=>'update',//(register,login,post_light,insert,update,upd,refresh,delete)
				'pushID'=>$web->sessionid, //推送编号
				'userID'=>$web->user['uid'],		//用户编号
				'siteID'=>$web->site[$web->siteid]['id'],		//目标网站编号
				'dataID'=>$web->data[$web->dataid]['ID'],		//被推送数据编号
				'status'=>0,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
				'oldInfo' => $web->history[$historyid] ,  //原来的id和url
				'error'=> array('level' => 1 , 'type' => '更新' , 'msg' => $web->errInfo , 'source' => $web->content) ,		
				'wid' => 	$web->site[$web->siteid]['wid'],		
				'real' => empty($web->user['real'])?0:1 ,	
				);
			$o->exe($output);	
			$web->dele();
			return 1;			
		}
	
}


//multipart/form-data 单名多值post_light设置函数
function curl_setopt_custom_postfields($ch, $postfields, $headers = null) {   
    $algos = hash_algos();   
    $hashAlgo = null;   
    foreach ( array('sha1', 'md5') as $preferred ) {   
        if ( in_array($preferred, $algos) ) {   
            $hashAlgo = $preferred;   
            break;   
        }   
    }   
    if ( $hashAlgo == null ) { list($hashAlgo) = $algos; }   
    $boundary =   
        '----------------------------' .   
        substr(hash($hashAlgo, 'cURL-php-multiple-value-same-key-support' . microtime()), 0, 12);   
  
    $body = array();   
    $crlf = "\r\n";   
    $fields = array();   
    foreach ( $postfields as $key => $value ) {   
        if ( is_array($value) ) {   
            foreach ( $value as $v ) {   
                $fields[] = array($key, $v);   
            }   
        } else {   
            $fields[] = array($key, $value);   
        }   
    }   
    foreach ( $fields as $field ) {   
        list($key, $value) = $field;   
        if ( strpos($value, '@') === 0 ) {   
            preg_match('/^@(.*?)$/', $value, $matches);   
            list($dummy, $filename) = $matches;   
            $body[] = '--' . $boundary;   
            $body[] = 'Content-Disposition: form-data; name="' . $key . '"; filename="' . basename($filename) . '"';   
            $body[] = 'Content-Type: image/pjpeg';   
            $body[] = '';   
            $body[] = file_get_contents($filename);   
        } else {   
            $body[] = '--' . $boundary;   
            $body[] = 'Content-Disposition: form-data; name="' . $key . '"';   
            $body[] = '';   
            $body[] = $value;   
        }   
    }   
    $body[] = '--' . $boundary . '--';   
    $body[] = '';   
    $contentType = 'multipart/form-data; boundary=' . $boundary;   
    $content = join($crlf, $body);   
    $contentLength = strlen($content);   
  
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(   
        'Content-Length: ' . $contentLength,   
        'Expect:',   
        'Content-Type: ' . $contentType,   
    ));   
  
    curl_setopt($ch, CURLOPT_POSTFIELDS, $content);   
  
} 


	function ConDB($dbInfo , $changeIp = "")	//连接数据库
	{
		if(!empty($changeIp))
		{
			$dbInfo['host'] = $changeIp ;
		}
		//$conn=mysql_connect($dbInfo['host'] ,$dbInfo['user'],$dbInfo['password']);
		$conn=mysql_connect('localhost' ,'root','root');
		if($conn == FALSE) return FALSE ;
		//if(!mysql_select_db($dbInfo['dbname'],$conn))
		if(!mysql_select_db('test',$conn))
		{
			mysql_close($conn) ;
			return FALSE ;
		}
		return $conn ;
	}


function processTransRet($o , $ret , $web , $type = '')
{
	if(($type == 1) || ($type == 2))	//出售出租页面概要
	{
		$output=array(
				'dataType'=> $type , //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
				'action'=>'trans',//(register,login,post_light,insert,update,upd,refresh,delete)
				'pushID'=> $web->sessionid, //推送编号
				'userID'=> $web->user['uid'],		//用户编号
				'siteID'=> $web->site[$web->siteid]['id'],		//目标网站编号
				'dataID'=> '' ,		//被推送数据编号
				'status'=> empty($ret)?0:9,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
				'source' => $ret ,			
				);
	}
	elseif(($type == 3) || ($type == 4))		//出售信息明细一条
	{
		$output=array(
			'dataType'=> $type , //被推送数据类型(new_buy,new_sale,rent,renter,second_buy,second_sale)
			'action'=>'trans',//(register,login,post_light,insert,update,upd,refresh,delete)
			'pushID'=> $web->sessionid, //推送编号
			'userID'=> $web->user['uid'],		//用户编号
			'siteID'=> $web->site[$web->siteid]['id'],		//目标网站编号
			'dataID'=> $web->data[$web->dataid]['ID'],		//被推送数据编号
			'status'=> empty($ret)?0:9,	//状态标志1:待发送 2:	待验证3:验证中4:验证失败,再验证5:验证超过允许的次数6:超时9:成功	0:失败
			'source' => $ret ,			
				);
	}
	$o->trans($output);	
	$web->dele();
	return 1;
}
function getip($team)
{
	$teamT = array(
		1=>'192.168.0.110',
		2=>'192.168.0.115',
		3=>'192.168.0.123',
		4=>'192.168.0.114',
		5=>'192.168.0.104',
		6=>'192.168.0.103',
		7=>'192.168.0.113',
		8=>'192.168.0.112',
		9=>'192.168.0.102',
	);
	$ip = $teamT[$team];
	if(!$ip)
		$ip = '127.0.0.1';
	return $ip;
}
?>

